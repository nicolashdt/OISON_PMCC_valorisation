---
title: "`r paste('Bilan des saisies opportunistes - Service départemental', params$dep, sep = '\n')`"
author: "OFB DR Hauts-de-France - Service régional Connaissance"
date: "`r format(Sys.time(), '%d %B %Y')`"
toc-title: "Sommaire"
output:
  word_document:
    toc: true
    reference_doc: "reference_doc.docx" # Référence de mise en forme
params:
  annee_fin: 2024
  annee_debut: 2020
  OISON: 'TRUE'  # mettre "TRUE"/"FALSE" pour prendre en compte les données OISON ou non
  PMC: 'TRUE'   # mettre "TRUE"/"FALSE" pour prendre en compte les données PMCC ou non
  dep: "80" # CHOISIR LE DEPARTEMENT
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE,
                      fig.align = "center",  # figure centrée
                      fig.retina = 4,      # Qualité des figures
                      out.width = "100%",      # remplissage de la largeur
                      dev = 'png',        # Format des figures
                      cache = FALSE)     # Pas d'enregistrement
library(sf)
library(dplyr)
library(tidyverse)
library(tmaptools)
library(ggplot2)
library(ggthemes)
library(gridExtra)
library(fmsb) # radarchart
library(reshape2) # permet de permuter les colonnes et les lignes d'un R.data
library(flextable) # permet de faire des beaux tableaux
library(scales) # format des nombres

colors_esp <- c(
  "Arachnides" = "#E41A1C",      # Rouge vif
  "Autres" = "#377EB8",          # Bleu foncé
  "Reptiles" = "#4DAF4A",        # Vert
  "Poissons" = "#984EA3",        # Violet foncé
  "Angiospermes" = "#FF7F00",    # Orange
  "Amphibiens" = "#FFF333",      # Jaune vif
  "Insectes" = "#A65628",        # Brun
  "Mammifères" = "#F781BF",      # Rose
  "PMC" = "#D8B365",             # Brun clair
  "Crustacés" = "#66DAA0",       # Vert turquoise
  "Oiseaux" = "#3288BD",         # Bleu clair
  "Non spécifié"= "#BBBBBB"      # Gris
)

colors_pmc <- c(
  "Fouine" = "#E63946",                     # Rouge vif
  "Blaireau européen" = "#FFF333",          # Jaune clair
  "Renard roux" = "#F1C40F",                # Jaune doré
  "Belette d'Europe" = "#A8DADC",           # Bleu clair
  "Raton laveur" = "#457B9D",               # Bleu foncé
  "Putois d'Europe" = "#F77F00",            # Orange vif
  "Hermine" = "#D52380",                    # Rose
  "Martre des pins" = "#9D4EDD",            # Violet
  "Chat sauvage" = "#2A9D8F",               # Vert turquoise
  "Castor d'Eurasie" = "#FFAB00"            # Jaune-orange
)

colors_dep <- c(
  "02" = "#FF6F61",   # Coral
  "80" = "#a57fc7",   # Violet
  "62" = "#88B04B",   # Greenery
  "59" = "#D2AB85",   # Light Brown
  "60" = "#92A8D1"    # Serenity
)

colors_statut <- c(
  "Envahissantes" = "#F77F00",   # Orange
  "Menacées" = "#3DAF2A",        # Vert clair
  "Normales" = "#377EB8"      # Bleu clair
)

colors_pro <- c(
  "Protégées" = "darkgreen",   # Vert
  "Non protégées" = "darkblue"  # Jaune
)

# Ouverture des fichiers utiliser dans le Rmarkdown
OISON_PMC <- st_read("../processed_data/OISON_PMC.gpkg")
departements <- st_read("../processed_data/departements.gpkg")

# Retirer les données du paraclet
OISON_PMC <- OISON_PMC %>% 
  filter(INSEE_COM!="80213")

#Filtrage des données à conserver : OISON et/ou PMC ?
nom_bases <- "(OISON+PMCC)"

if(params$OISON=="FALSE"){
  OISON_PMC <- OISON_PMC %>% 
  filter(GROUP2_INPN == "PMC") %>% 
  mutate(GROUP2_INPN = nom_vernaculaire) 
  nom_bases <-  "(PMC)"
  colors_esp <- colors_pmc}

if(params$PMC=="FALSE"){
  OISON_PMC <- OISON_PMC %>% 
  filter(GROUP2_INPN != "PMC")
  nom_bases <-  "(OISON)"}

if(params$PMC=="FALSE" & params$OISON=="FALSE"){
  nom_bases <-  "(AUCUNE BASE DE DONNEE)"}

```

# Introduction
Les données présentées sont issues des bases de données OISON et du réseau-PMCC de l'OFB. Elles font ici l'objet d'un suivi sur le nombre de saisies, le nombre d'observateurs, la saisie moyenne par observateur, les groupes d'espèces, leur statut dans les listes rouges ou envahissantes, les espèces protégées en France et leur répartition géographique.

Un observateur est relié au département dans lequel il a le plus saisie.

Les saisies sur la commune de Cottenchy (80) ont été exclues.

A propos de OISON :

Depuis toujours les agents de l'OFB sur le terrain réalisent des observations qu'ils peuvent maintenant compiler dans un outil informatique permettant la saisie informatique en mode nomade des observations relatives aux espèces et aux milieux. Les données collectées sont majoritairement le résultat d'observations opportunistes ou fortuites, mais elles peuvent aussi être le résultat de la mise en œuvre de protocoles qui se caractérisent par des formulaires simples (nombre de champs réduits).

A propos de rézo-PMCC :

Le réseau Petits et mésocarnivores (PMC) suit l’évolution de la répartition des populations de 14 espèces de carnivores en France métropolitaine, aux statuts règlementaires et de conservation variés. Les connaissances acquises grâce à ce réseau interne permettent à l’Office français de la biodiversité (OFB) d’apporter une expertise technique et scientifique sur ces espèces à tous les niveaux : départemental, régional, national et européen.

\newpage

# Evolutions sur les saisies `r nom_bases`

## Evolution de la saisie

```{r}
saisies_dep <- OISON_PMC %>% 
  st_set_geometry(NULL) %>%                          # Supprime la géométrie des données spatiales
  filter(INSEE_DEP == params$dep) %>% 
  filter(annee >= params$annee_debut & annee <= params$annee_fin) %>%  # Filtre les années
  group_by(annee,INSEE_DEP) %>%                     # Regroupe les données par année
  summarise(nombre_saisies_dep = n())                    # Calcule le nombre de saisies par groupe

saisies_reg <- OISON_PMC %>% 
  st_set_geometry(NULL) %>%                          # Supprime la géométrie des données spatiales
  filter(annee >= params$annee_debut & annee <= params$annee_fin) %>%  # Filtre les années
  group_by(annee) %>%                     # Regroupe les données par année
  summarise(nombre_saisies_reg = n())  
```

<br>

```{r , fig.width = 6 , fig.height = 3.5}
# Jointure des 2 tableaux
saisies_tableau <- saisies_dep %>%
  select(-INSEE_DEP) %>% 
  right_join(saisies_reg) %>% 
  mutate(Contribution = (nombre_saisies_dep/nombre_saisies_reg)) %>% 
  mutate(across(Contribution, ~ percent(., big.mark = " ", decimal.mark = ",", accuracy = 1))) #transforme les valeurs de la colonne Contribution en pourcentage

# Appliquer le format français aux colonnes appropriées
saisies_tableau <- saisies_tableau %>%
  mutate(across(nombre_saisies_dep,
                ~ format(., big.mark = " ", decimal.mark = ",", scientific = FALSE, trim = TRUE))) %>%
  mutate(across(nombre_saisies_reg,
                ~ format(., big.mark = " ", decimal.mark = ",", scientific = FALSE, trim = TRUE))) %>%
  mutate(annee = as.character(annee)) 

width(
  
flextable(saisies_tableau) %>%
  set_header_labels(
    annee = "Année",
    nombre_saisies_dep = paste("SD",params$dep),
    nombre_saisies_reg = "Région"
  ) %>%
  theme_vanilla() %>%
  color(part = "header", color = "white") %>%
  bg(part = "header", bg = "#333333") %>%
  bold(part = "header") %>% 
  align(j = 2:4, align = "right") %>%   # Aligner à droite les colonnes de saisies
  align(part = "header",j = 2:4, align = "right") %>% 
  set_caption(caption = paste("Evolution du nombre de saisies",nom_bases))
  
, width = 1.5)
```

```{r , fig.width = 6.5 , fig.height = 3.5}
ggplot(saisies_dep) +
  aes(x = annee, y = nombre_saisies_dep, color = INSEE_DEP) + 
  geom_smooth(show.legend = FALSE) +  # Cacher la légende
  scale_color_manual(values = colors_dep) + 
  labs(
    x = "Années",
    y = "Nombre de saisies",
    title = paste("Evolution du nombre de saisies pour le SD", params$dep, nom_bases)
  ) +
  geom_text(aes(label = nombre_saisies_dep, x = annee),
            position = position_nudge(y = max(saisies_dep$nombre_saisies_dep)/10),
            size = 3,
            show.legend = FALSE) +
  theme_minimal() +
  theme(text = element_text(size = 9))
```

\newpage

## Evolution du nombre d'observateurs

```{r}
observateurs_dep <- OISON_PMC %>% 
  filter(annee >= params$annee_debut & annee <= params$annee_fin) %>%
  st_set_geometry(NULL) %>% 
  select(annee, INSEE_DEP, Observateur) %>%
  # Compter le nombre d'observations par observateur et département
  group_by(annee, INSEE_DEP, Observateur) %>%
  summarise(nombre_observations = n(), .groups = 'drop') %>%
  # Trouver le maximum de nombre d'observations par observateur
  group_by(annee, Observateur) %>%
  filter(nombre_observations == max(nombre_observations)) %>%
  ungroup() %>%
  # Déduire le département avec le maximum d'observations pour chaque observateur
  group_by(annee, INSEE_DEP) %>%
  summarise(nombre_observateurs_dep = n_distinct(Observateur), .groups = 'drop') %>% 
  # Filtrer pour le dep
  filter(INSEE_DEP == params$dep)

observateurs_reg <- OISON_PMC %>% 
  filter(annee >= params$annee_debut & annee <= params$annee_fin) %>%
  st_set_geometry(NULL) %>% 
  group_by(annee) %>%
  summarise(nombre_observateurs_reg = n_distinct(Observateur))

```

<br>

```{r , fig.width = 6 , fig.height = 3.5}
# Jointure des 2 tableaux
observateurs_tableau <- observateurs_dep %>%
  select(-INSEE_DEP) %>% 
  right_join(observateurs_reg) %>% 
  mutate(Contribution = (nombre_observateurs_dep/nombre_observateurs_reg)) %>% 
  mutate(across(Contribution, ~ percent(., big.mark = " ", decimal.mark = ",", accuracy = 1)))

# Appliquer le format français aux colonnes appropriées
observateurs_tableau <- observateurs_tableau %>%
  mutate(across(nombre_observateurs_dep,
                ~ format(., big.mark = " ", decimal.mark = ",", scientific = FALSE, trim = TRUE))) %>%
  mutate(across(nombre_observateurs_reg,
                ~ format(., big.mark = " ", decimal.mark = ",", scientific = FALSE, trim = TRUE))) %>%
  mutate(annee = as.character(annee)) 

width(
  
flextable(observateurs_tableau) %>%
  set_header_labels(
    annee = "Année",
    nombre_observateurs_dep = paste("SD",params$dep),
    nombre_observateurs_reg = "Région"
  ) %>%
  theme_vanilla() %>%
  color(part = "header", color = "white") %>%
  bg(part = "header", bg = "#333333") %>%
  bold(part = "header") %>% 
  align(j = 2:4, align = "right") %>%   # Aligner à droite les colonnes de saisies
  align(part = "header",j = 2:4, align = "right") %>% 
  set_caption(caption = paste("Evolution du nombre d'observateurs",nom_bases))
  
, width = 1.5)
```

<br>

```{r , fig.width = 6.5 , fig.height = 3.5}
ggplot(observateurs_dep) +
  aes(x = annee, y = nombre_observateurs_dep, color = INSEE_DEP) +
  geom_smooth(show.legend = FALSE) +
  scale_color_manual(values = colors_dep) +
  labs(
    x = "Années",
    y = "Nombre d'observateurs",
    fill = "Départements",
    title = paste("Evolution du nombre d'observateurs pour le SD", params$dep, nom_bases)
  ) +
  geom_text(aes(label = nombre_observateurs_dep, x = annee),
            position = position_nudge(y = max(observateurs_dep$nombre_observateurs_dep)/10),
            size = 3,
            show.legend = FALSE) +
  theme_minimal() +
  theme(text = element_text(size = 9))
```

\newpage

## Evolution du nombre de saisie par observateur

```{r}
saisies_observateur_dep <- saisies_dep %>%
  left_join(observateurs) %>%
  mutate(moyenne_saisies_observateur_dep =
           ifelse(!is.na(nombre_observateurs_dep)
                  & nombre_observateurs_dep > 0, 
                  round(nombre_saisies / nombre_observateurs_dep,1), 
                  0)) %>% 
  select(annee,INSEE_DEP,moyenne_saisies_observateur_dep)

saisies_observateur_reg <- OISON_PMC %>%
  st_set_geometry(NULL) %>%
  filter(annee >= params$annee_debut & annee <= params$annee_fin) %>%
  group_by(annee, Observateur) %>%
  summarise(nombre_saisies = n()) %>%
  group_by(annee) %>%
  summarise(moyenne_saisies_observateur_reg = round(mean(nombre_saisies),1))
```

<br>

```{r , fig.width = 6 , fig.height = 3.5}
# Jointure des 2 tableaux
saisies_observateur_tableau <- saisies_observateur_dep %>%
  select(-INSEE_DEP) %>% 
  right_join(saisies_observateur_reg) %>% 
  mutate(Ratio = (moyenne_saisies_observateur_dep/moyenne_saisies_observateur_reg)) %>% 
  mutate(across(Ratio, ~ percent(., big.mark = " ", decimal.mark = ",", accuracy = 1)))

# Appliquer le format français aux colonnes appropriées
saisies_observateur_tableau <- saisies_observateur_tableau %>%
  mutate(across(moyenne_saisies_observateur_dep,
                ~ format(., big.mark = " ", decimal.mark = ",", scientific = FALSE, trim = TRUE))) %>%
  mutate(across(moyenne_saisies_observateur_reg,
                ~ format(., big.mark = " ", decimal.mark = ",", scientific = FALSE, trim = TRUE))) %>%
  mutate(annee = as.character(annee)) 

width(
  
flextable(saisies_observateur_tableau) %>%
  set_header_labels(
    annee = "Année",
    moyenne_saisies_observateur_dep = paste("SD",params$dep),
    moyenne_saisies_observateur_reg = "Région"
  ) %>%
  theme_vanilla() %>%
  color(part = "header", color = "white") %>%
  bg(part = "header", bg = "#333333") %>%
  bold(part = "header") %>% 
  align(j = 2:4, align = "right") %>%   # Aligner à droite les colonnes de saisies
  align(part = "header",j = 2:4, align = "right") %>% 
  set_caption(caption = paste("Evolution du nombre moyen de saisies par observateurs", nom_bases))
  
, width = 1.5)
```

<br>

```{r , fig.width = 6.5 , fig.height = 3.5}
ggplot(saisies_observateur_dep) +
  aes(x = annee, y = moyenne_saisies_observateur_dep, color = INSEE_DEP) +
  geom_smooth(show.legend = FALSE) +
  scale_color_manual(values = colors_dep) +
  labs(
    x = "Années",
    y = "Nombre de saisies par observateur",
    fill = "Départements",
    title = paste("Evolution du nombre moyen de saisies par observateurs pour le SD", params$dep, nom_bases)
  ) +
  geom_text(aes(label = moyenne_saisies_observateur_dep, x = annee),
            position = position_nudge(y = max(saisies_observateur_dep$moyenne_saisies_observateur_dep)/10),
            size = 3,
            show.legend = FALSE) +
  theme_minimal() +
  theme(text = element_text(size = 9))
```

```{r}
saisies_observateur_violon <- OISON_PMC %>%
  filter(annee == params$annee_fin) %>% 
  filter(INSEE_DEP == params$dep) %>% 
  group_by(annee, INSEE_DEP, Observateur) %>%
  summarise(nombre_saisies = n())
  
```

<br>

```{r , fig.width = 6.5 , fig.height = 3.5}
ggplot(saisies_observateur_violon, aes(x = factor(INSEE_DEP), y = nombre_saisies, fill=INSEE_DEP)) +
  geom_violin(color = "black") +
  scale_fill_manual(values = colors_dep) +
  stat_summary(fun = mean, geom = "point", shape = 18, size = 3, color = "red", fill = "red") +
  stat_summary(fun = median, geom = "point", shape = 15, size = 2, color = "black",fill="black") +
  labs(
    x = "Département",
    y = "Nombre de saisies par observateur",
    title = paste("Répartition du nombre de saisies par observateur pour le SD", params$dep,"en",params$annee_fin, nom_bases),
    caption = "Explications :
    - Pour un nombre de saisie donné, plus la zone est large, plus il y a d'observateurs
    - Le carré noir représente la médiane.
    - Le losange rouge représente la moyenne"
  ) +
  theme_minimal()+
  theme(plot.caption = element_text(hjust = 0, size = 10, margin = margin(t = 10))) +
  theme(text = element_text(size = 9),
        plot.margin = margin(t = 1, r = 5, b = 1, l = 1),
        legend.margin = margin(t = 1, r = 200, b = 1, l = 1))
```

\newpage

# Evolution sur les espèces

## Evolution du nombre de saisies par groupe d'espèces

```{r}
groupes_espece_par_annee <- OISON_PMC %>% 
 filter(annee >= params$annee_debut & annee <= params$annee_fin) %>%
  filter(GROUP2_INPN != "Non spécifié") %>% 
  filter(INSEE_DEP==params$dep) %>% 
  filter(!is.na(GROUP2_INPN)) %>% 
  group_by(annee,GROUP2_INPN) %>% 
  summarise(nb_saisies = n()) %>% 
  st_set_geometry(NULL) %>% 
  arrange(desc(nb_saisies))

# Ordre des espèces dans la légende décroissante
groupes_espece_par_annee$GROUP2_INPN <- factor(groupes_espece_par_annee$GROUP2_INPN, 
                                               levels = unique(groupes_espece_par_annee$GROUP2_INPN))
```

```{r , fig.width = 6.5 , fig.height = 3.5}
ggplot(groupes_espece_par_annee) +
  aes(x = annee, y = nb_saisies, colour = GROUP2_INPN) +
  geom_smooth(se = FALSE) +
  geom_point()+
  scale_colour_manual(values = colors_esp) +
  labs(x = "Années",
       y = "Nombre de saisies",
       colour = "Groupes d'espèces",
       title = paste("Evolution du nombre de saisies par groupe d'espèces pour le SD", params$dep,nom_bases)) +
  theme_minimal() +
  theme(text = element_text(size = 9))
```

```{r}
groupes_espece <- OISON_PMC %>% 
  group_by(GROUP2_INPN) %>% 
  filter(INSEE_DEP==params$dep) %>% 
  filter(!is.na(GROUP2_INPN)) %>% 
  filter(annee==params$annee_fin) %>% 
  summarise(nb_saisies = n()) %>% 
  st_set_geometry(NULL) %>% 
  arrange(nb_saisies) %>% 
  mutate(pourcentage = round((nb_saisies / sum(nb_saisies)) * 100)) %>% 
  mutate(cumulative = pourcentage / 2 + c(0, cumsum(pourcentage)[-length(pourcentage)]))

# Ordre des espèces décoissant  
groupes_espece$GROUP2_INPN <- groupes_espece$GROUP2_INPN %>% 
  factor(levels = rev(groupes_espece$GROUP2_INPN))
```

```{r , fig.width = 6.5 , fig.height = 3.5}
ggplot(groupes_espece)+
  aes(x = factor(1), y = pourcentage, fill = GROUP2_INPN) +
  geom_bar(width = 1, stat = "identity", color = "white") +
  coord_polar(theta = "y")+
  theme_void()+
  scale_fill_manual(values = colors_esp) +
  
  geom_text(data=tail(groupes_espece,3),
            aes(x = 1.8, 
                y = cumulative, 
                label=paste(GROUP2_INPN,"\n",pourcentage, "%")),
                size = 3)+
  labs(
    fill = "Groupes d'espèces",
    title = paste("Proportions des saisies par groupe d'espèces pour le SD", params$dep,"en",params$annee_fin,nom_bases)
    ) +
  theme(
    text = element_text(size = 9),
    plot.title = element_text(hjust = 0.2),  # Aligne le titre à gauche
    legend.margin = margin(t = 0, r = 0, b = 0, l = 50),  # Espace à gauche de la légende
    plot.margin = margin(t = 1, r = 1, b = 1, l = 1)
  )
```
\newpage
<br>

```{r , fig.width = 6 , fig.height = 3.5}
#Pour la Région
groupes_espece_reg <- OISON_PMC %>% 
  group_by(GROUP2_INPN) %>% 
  filter(!is.na(GROUP2_INPN)) %>% 
  filter(annee==params$annee_fin) %>% 
  summarise(nb_saisies_reg = n()) %>% 
  st_set_geometry(NULL) 

# Pour le département
groupes_espece_tableau <- OISON_PMC %>%
  filter(INSEE_DEP==params$dep) %>% 
  filter(!is.na(GROUP2_INPN)) %>% 
  filter(annee==params$annee_fin) %>% 
  group_by(GROUP2_INPN) %>% 
  summarise(nb_saisies = n()) %>% 
  st_set_geometry(NULL) %>% 
  right_join(groupes_espece_reg) %>%
  replace_na(list(nb_saisies=0))

# Calcul de la ligne "Total" et des pourcentages
totaux <- groupes_espece_tableau %>%
  summarise(across(where(is.numeric), sum, na.rm = TRUE)) %>%
  mutate(GROUP2_INPN = "Total")
  
groupes_espece_tableau <- groupes_espece_tableau %>% 
  bind_rows(totaux) %>% 
  arrange(nb_saisies) %>% 
  mutate(pourcentage = round((nb_saisies / totaux$nb_saisies) * 100)) %>%
  relocate(pourcentage,.after=nb_saisies) %>% 
  mutate(Contribution = (nb_saisies/nb_saisies_reg)) %>% 
  mutate(across(Contribution, ~ percent(., big.mark = " ", decimal.mark = ",", accuracy = 1))) %>% 
  mutate(across(nb_saisies, ~ format(., big.mark = " ", decimal.mark = ",", scientific = FALSE, trim = TRUE))) %>% 
  mutate(across(nb_saisies_reg, ~ format(., big.mark = " ", decimal.mark = ",", scientific = FALSE, trim = TRUE))) %>% 
  mutate(across(pourcentage, ~ percent(./100, big.mark = " ", decimal.mark = ",", accuracy = 1)))

groupes_espece_tableau$GROUP2_INPN <- groupes_espece_tableau$GROUP2_INPN %>% 
  factor(levels = rev(groupes_espece_tableau$GROUP2_INPN))

width(
  
flextable(groupes_espece_tableau) %>%
  set_header_labels(
    nb_saisies = paste("SD",params$dep),
    GROUP2_INPN = "Groupes d'espèces",
    pourcentage = "%",
    nb_saisies_reg = "Région") %>% 
  theme_vanilla() %>%
  color(part = "header", color = "white") %>%
  bg(part = "header", bg = "#333333") %>%
  bold(part = "header") %>% 
  align(j = 2:5, align = "right") %>%   # Aligner à droite les colonnes de saisies
  align(part = "header",j = 2:5, align = "right") %>% 
  set_caption( caption = paste("Nombre de saisies par groupe d'espèces en", params$anne_fin, nom_bases)) %>% 
  bg(i=nrow(groupes_espece_tableau), bg = "#DDDDDD")
  
, width = 1.5)
```

```{r, results='asis'}
# Condition pour afficher le titre
if (params$OISON) {
  cat("\\newpage\n")
  cat("## Evolution du nombre de saisies par groupe d'espèces (sans oiseaux)\n")
}
```

```{r}
if (params$OISON) {
  groupes_espece_par_annee_sans_oiseaux <- OISON_PMC %>% 
    filter(GROUP2_INPN != "Non spécifié") %>% 
    filter(INSEE_DEP==params$dep) %>% 
    group_by(annee, GROUP2_INPN) %>% 
    filter(annee >= params$annee_debut & annee <= params$annee_fin) %>%
    filter(GROUP2_INPN != "Oiseaux") %>%
    summarise(nb_saisies = n()) %>% 
    st_set_geometry(NULL) %>% 
    arrange(desc(nb_saisies))

  # Ordre des espèces dans la légende décroissante
  groupes_espece_par_annee_sans_oiseaux$GROUP2_INPN <- factor(
    groupes_espece_par_annee_sans_oiseaux$GROUP2_INPN, 
    levels = unique(groupes_espece_par_annee_sans_oiseaux$GROUP2_INPN)
  )
}
```

```{r , fig.width = 6.5 , fig.height = 3.5}
if (params$OISON) {
  ggplot(groupes_espece_par_annee_sans_oiseaux) +
    aes(x = annee, y = nb_saisies, colour = GROUP2_INPN) +
    geom_smooth(se = FALSE) +
    geom_point() +
    scale_colour_manual(values = colors_esp) +
    labs(x = "Années",
         y = "Nombre de saisies",
         colour = "Groupes d'espèces",
         title = paste("Nombre de saisies par groupe d'espèces sans les oiseaux pour le SD", params$dep, nom_bases)) +
    theme_minimal() +
    theme(text = element_text(size = 9))
}
```

```{r}
if (params$OISON) {
  groupes_espece_sans_oiseaux <- OISON_PMC %>% 
    filter(INSEE_DEP==params$dep) %>% 
    group_by(GROUP2_INPN) %>% 
    filter(annee == params$annee_fin) %>% 
    filter(GROUP2_INPN != "Oiseaux") %>% 
    summarise(nb_saisies = n()) %>% 
    st_set_geometry(NULL) %>% 
    arrange(nb_saisies) %>% 
    mutate(pourcentage = round((nb_saisies / sum(nb_saisies)) * 100)) %>% 
    mutate(cumulative = pourcentage / 2 + c(0, cumsum(pourcentage)[-length(pourcentage)]))

  # Ordre des espèces décroissant  
  groupes_espece_sans_oiseaux$GROUP2_INPN <- groupes_espece_sans_oiseaux$GROUP2_INPN %>% 
    factor(levels = rev(groupes_espece_sans_oiseaux$GROUP2_INPN))
}
```

```{r , fig.width = 6.5 , fig.height = 3.5}
if (params$OISON) {
  ggplot(groupes_espece_sans_oiseaux) +
    aes(x = factor(1), y = pourcentage, fill = GROUP2_INPN) +
    geom_bar(width = 1, stat = "identity", color = "white") +
    coord_polar(theta = "y") +
    theme_void() +
    scale_fill_manual(values = colors_esp) +
    
    geom_text(data = tail(groupes_espece_sans_oiseaux, 6),
              aes(x = 1.8, 
                  y = cumulative, 
                  label = paste(GROUP2_INPN, "\n", pourcentage, "%")),
                  size = 3) +
    labs(
      fill = "Groupes d'espèces",
      title = paste("Saisies par groupe d'espèces sans les oiseaux pour le SD", params$dep,"en", params$annee_fin, nom_bases)
    ) +
  theme(
    text = element_text(size = 9),
    plot.title = element_text(hjust = 0.2),  # Aligne le titre à gauche
    legend.margin = margin(t = 0, r = 0, b = 0, l = 30),  # Espace à gauche de la légende
    plot.margin = margin(t = 1, r = 2, b = 1, l = 1)
  )
}
```

\newpage

## Proportions d'espèces entre `r params$annee_debut` et `r params$annee_fin`

<br> Graphique radar sur les proportions (%) d'espèces saisies sans les oiseaux de `r params$annee_debut` à `r params$annee_fin` : <br>

```{r}
# Fonction pour créer des graphiques radars (library(fmsb))
create_beautiful_radarchart <- function(data, color = "#00AFBB", 
                                        vlabels = colnames(data), vlcex = 0.7,
                                        caxislabels = NULL, title = NULL, plwd = 2,...){
  radarchart(
    data, axistype = 1,
    # Personnaliser le polygone
    pcol = color, pfcol = scales::alpha(color, 0.5), plwd = 2, plty = 1,
    # Personnaliser la grille
    cglcol = "grey", cglty = 1, cglwd = 0.8,
    # Personnaliser l'axe
    axislabcol = "grey", 
    # Étiquettes des variables
    vlcex = vlcex, vlabels = vlabels,
    caxislabels = caxislabels, title = title, ...
  )
}
```

```{r}
# Filtrage et regroupement des données
radar_especes_dep <- OISON_PMC %>% 
  filter(INSEE_DEP==params$dep) %>% 
  filter(annee >= params$annee_debut & annee <= params$annee_fin) %>%
  filter(GROUP2_INPN != "Oiseaux") %>% 
  filter(GROUP2_INPN != "Non spécifié") %>% 
  group_by(GROUP2_INPN, INSEE_DEP) %>% 
  summarise(nb_saisies = n(), .groups = 'drop') %>% 
  st_set_geometry(NULL)

# Calcul des totaux par département
totaux2 <- OISON_PMC %>% 
  filter(annee >= params$annee_debut & annee <= params$annee_fin) %>%
  filter(INSEE_DEP==params$dep) %>%
  filter(GROUP2_INPN != "Oiseaux") %>% 
  group_by(INSEE_DEP) %>% 
  st_set_geometry(NULL) %>% 
  summarise(total = n(), .groups = 'drop')

# Fusionner les deux tables
radar_especes_dep <- radar_especes_dep %>% 
  left_join(totaux2, by = "INSEE_DEP") %>%
  mutate(pourcentage = round((nb_saisies / total )*100,0))

radar_especes_dep <- radar_especes_dep %>%
  dcast(INSEE_DEP ~ GROUP2_INPN, value.var = "pourcentage", fill = 0)

# Combine max/min with the radar data
radar_especes_dep <- rbind(rep(100,ncol(radar_especes_dep)),rep(0,ncol(radar_especes_dep)), radar_especes_dep)
```

```{r , fig.width = 6.5 , fig.height = 5}
# Réduire la marge du graphique à l'aide de par()
# Diviser l'écran en 3 parties
op <- par(mar = c(1, 1,1,1))
par(mfrow = c(1,1))
# Create radar charts
  create_beautiful_radarchart(
    vlcex = 0.9,
    color = colors_dep[radar_especes_dep$INSEE_DEP[3]],
    data = select(radar_especes_dep[c(1, 2, 3), ], -INSEE_DEP),
    caxislabels = seq.int(0,100,length.out = 5),  # Adjust caxislabels as needed
    title = radar_especes_dep$INSEE_DEP[3]   # Ensure titles is defined
  )
par(op)
```

\newpage

# Evolution sur les espèces menacées et envahissantes

## Evolution du nombre de saisies par statut

```{r}
statuts_espece_par_annee <- OISON_PMC %>% 
  filter(INSEE_DEP==params$dep) %>% 
  filter(annee >= params$annee_debut & annee <= params$annee_fin) %>%
  st_set_geometry(NULL) %>% 
  filter(!is.na(statut_LR)) %>% 
  group_by(annee,statut_LR) %>% 
  summarise(nb_saisies = n()) %>% 
  arrange(desc(nb_saisies))

# Ordre des espèces dans la légende décroissante
statuts_espece_par_annee$statut_LR <- factor(statuts_espece_par_annee$statut_LR, 
                                               levels = unique(statuts_espece_par_annee$statut_LR))
```

<br>

```{r , fig.width = 6 , fig.height = 3.5}
# Transformation en tableau croisé dynamique
statuts_espece_par_annee_tableau <- statuts_espece_par_annee %>%
  dcast(annee ~ statut_LR, value.var = "nb_saisies", fill = 0) %>% # transforme en tableau
  mutate(total = rowSums(select(., -annee), na.rm = TRUE)) %>% # calcul les totaux
  mutate(annee = as.character(annee)) # met annee en caractere

# Appliquer le format français aux colonnes appropriées
statuts_espece_par_annee_tableau <- statuts_espece_par_annee_tableau %>%
  mutate(across(-annee, ~ format(., big.mark = " ", decimal.mark = ",", scientific = FALSE, trim = TRUE)))

width(
  
flextable(statuts_espece_par_annee_tableau) %>%
  set_header_labels(
    annee = "Année",
    total = "Total"
  ) %>%
  theme_vanilla() %>%
  color(part = "header", color = "white") %>%
  bg(part = "header", bg = "#333333") %>%
  bold(part = "header") %>% 
  align(j = 2:4, align = "right") %>%   # Aligner à droite les colonnes de saisies
  align(part = "header",j = 2:4, align = "right") %>% 
  set_caption(caption = paste("Evolution du nombre de saisies par statut pour le SD", params$dep, nom_bases)) %>% 
  set_table_properties(width = 0.8, layout = "autofit")
  
, width = 1)
```

<br>

```{r , fig.width = 6.5 , fig.height = 3.5}
ggplot(statuts_espece_par_annee) +
  aes(x = annee, y = nb_saisies, colour = statut_LR) +
  geom_smooth(se = FALSE) +
  geom_point()+
  scale_colour_manual(values = colors_statut) +
  labs(x = "Années",
       y = "Nombre de saisies",
       colour = "Statut espèce",
       title = paste("Evolution du nombre de saisies par statut pour le SD", params$dep, nom_bases)) +
  theme_minimal() +
  theme(text = element_text(size = 9))
```

```{r , fig.width = 6.5 , fig.height = 3.5}
statuts_espece <- OISON_PMC %>%
  filter(INSEE_DEP==params$dep) %>% 
  st_set_geometry(NULL) %>% 
  filter(annee==params$annee_fin) %>% 
  filter(!is.na(statut_LR)) %>% 
  group_by(statut_LR) %>% 
  summarise(nb_saisies = n()) %>% 
  arrange(nb_saisies) %>% 
  mutate(pourcentage = round((nb_saisies / sum(nb_saisies)) * 100)) %>% 
  mutate(cumulative = pourcentage / 2 + c(0, cumsum(pourcentage)[-length(pourcentage)]))

# Ordre des espèces décoissant  
statuts_espece$statut_LR <- statuts_espece$statut_LR %>% 
  factor(levels = rev(statuts_espece$statut_LR))
```

```{r , fig.width = 6.5 , fig.height = 3.5}
ggplot(statuts_espece)+
  aes(x = factor(1), y = pourcentage, fill = statut_LR) +
  geom_bar(width = 1, stat = "identity", color = "white") +
  coord_polar(theta = "y")+
  theme_void()+
  scale_fill_manual(values = colors_statut) +
  
  geom_text(data=tail(statuts_espece,4),
            aes(x = 1.8, 
                y = cumulative, 
                label=paste(statut_LR,"\n",pourcentage, "%")),
                size = 3)+
  labs(
    fill = "Groupes d'espèces",
    title = paste("Proportions des saisies par statut d'espèce pour le SD", params$dep,"en", params$annee_fin,nom_bases)
    ) +
  theme(
    text = element_text(size = 9),
    plot.title = element_text(hjust = 0.2),  # Aligne le titre à gauche
    legend.margin = margin(t = 0, r = 0, b = 0, l = 50),  # Espace à gauche de la légende
    plot.margin = margin(t = 1, r = 1, b = 1, l = 1)
  )
```

```{r , fig.width = 6.5 , fig.height = 3.5}
statuts_espece_dep <- OISON_PMC %>% 
  filter(INSEE_DEP==params$dep) %>% 
  filter(annee==params$annee_fin) %>% 
  filter(!is.na(statut_LR))

ggplot(statuts_espece_dep) +
  aes(x = statut_LR, fill = INSEE_DEP) +
  geom_bar(position = "dodge2") +
  scale_fill_manual(values = colors_dep) +
  labs(
    x = "Statuts",
    y = "Nombre de saisies",
    fill = "Départements",
    title = paste("Nombre de saisies par statuts d'espèces pour le SD", params$dep,"en", params$annee_fin, nom_bases)) +
  theme_minimal() +
  theme(text = element_text(size = 9),
        legend.margin = margin(t = 0, r = 200, b = 0, l = 0))
```

\newpage
# Evolution sur les espèces protégées

```{r}
espece_pro_par_annee <- OISON_PMC %>% 
  filter(INSEE_DEP==params$dep) %>% 
  filter(annee >= params$annee_debut & annee <= params$annee_fin) %>%
  st_set_geometry(NULL) %>% 
  filter(!is.na(espece_pro)) %>% 
  group_by(annee,espece_pro) %>% 
  summarise(nb_saisies = n()) %>% 
  arrange(desc(nb_saisies))

# Ordre des espèces dans la légende décroissante
espece_pro_par_annee$espece_pro <- factor(espece_pro_par_annee$espece_pro, 
                                               levels = unique(espece_pro_par_annee$espece_pro))
```

<br>

```{r , fig.width = 6 , fig.height = 3.5}
# Transformation en tableau croisé dynamique
espece_pro_par_annee_tableau <- espece_pro_par_annee %>%
  dcast(annee ~ espece_pro, value.var = "nb_saisies", fill = 0) %>% # transforme en tableau
  mutate(total = rowSums(select(., -annee), na.rm = TRUE)) %>% # calcul les totaux
  mutate(annee = as.character(annee)) # met annee en caractere

# Appliquer le format français aux colonnes appropriées
espece_pro_par_annee_tableau <- espece_pro_par_annee_tableau %>%
  mutate(across(-annee, ~ format(., big.mark = " ", decimal.mark = ",", scientific = FALSE, trim = TRUE)))

width(
  
flextable(espece_pro_par_annee_tableau) %>%
  set_header_labels(
    annee = "Année",
    total = "Total"
  ) %>%
  theme_vanilla() %>%
  color(part = "header", color = "white") %>%
  bg(part = "header", bg = "#333333") %>%
  bold(part = "header") %>% 
  align(j = 2:4, align = "right") %>%   # Aligner à droite les colonnes de saisies
  align(part = "header",j = 2:4, align = "right") %>% 
  set_caption(caption = paste("Evolution du nombre de saisies des espèces protégées pour le SD", params$dep, nom_bases))
  
, width = 1.4)
```

<br>

```{r , fig.width = 6 , fig.height = 3.5}
#Pour la Région
groupes_espece_pro_reg <- OISON_PMC %>% 
  group_by(GROUP2_INPN) %>% 
  filter(!is.na(GROUP2_INPN)) %>% 
  filter(espece_pro=="Protégées") %>%
  filter(annee==params$annee_fin) %>% 
  summarise(nb_saisies_reg = n()) %>% 
  st_set_geometry(NULL) 

# Pour le département
groupes_espece_pro_tableau <- OISON_PMC %>%
  filter(INSEE_DEP==params$dep) %>% 
  filter(!is.na(GROUP2_INPN)) %>% 
  filter(espece_pro=="Protégées") %>%
  filter(annee==params$annee_fin) %>% 
  group_by(GROUP2_INPN) %>% 
  summarise(nb_saisies = n()) %>% 
  st_set_geometry(NULL) %>% 
  right_join(groupes_espece_pro_reg) %>%
  replace_na(list(nb_saisies=0))

# Calcul de la ligne "Total" et des pourcentages
totaux <- groupes_espece_pro_tableau %>%
  summarise(across(where(is.numeric), sum, na.rm = TRUE)) %>%
  mutate(GROUP2_INPN = "Total")
  
groupes_espece_pro_tableau <- groupes_espece_pro_tableau %>% 
  bind_rows(totaux) %>% 
  arrange(nb_saisies) %>% 
  mutate(pourcentage = round((nb_saisies / totaux$nb_saisies) * 100)) %>%
  relocate(pourcentage,.after=nb_saisies) %>% 
  mutate(Contribution = (nb_saisies/nb_saisies_reg)) %>% 
  mutate(across(Contribution, ~ percent(., big.mark = " ", decimal.mark = ",", accuracy = 1))) %>% 
  mutate(across(nb_saisies, ~ format(., big.mark = " ", decimal.mark = ",", scientific = FALSE, trim = TRUE))) %>% 
  mutate(across(nb_saisies_reg, ~ format(., big.mark = " ", decimal.mark = ",", scientific = FALSE, trim = TRUE))) %>% 
  mutate(across(pourcentage, ~ percent(./100, big.mark = " ", decimal.mark = ",", accuracy = 1)))

groupes_espece_pro_tableau$GROUP2_INPN <- groupes_espece_pro_tableau$GROUP2_INPN %>% 
  factor(levels = rev(groupes_espece_pro_tableau$GROUP2_INPN))

width(
  
flextable(groupes_espece_pro_tableau) %>%
  set_header_labels(
    nb_saisies = paste("SD",params$dep),
    GROUP2_INPN = "Groupes d'espèces protégées",
    pourcentage = "%",
    nb_saisies_reg = "Région") %>% 
  theme_vanilla() %>%
  color(part = "header", color = "white") %>%
  bg(part = "header", bg = "#333333") %>%
  bold(part = "header") %>% 
  align(j = 2:5, align = "right") %>%   # Aligner à droite les colonnes de saisies
  align(part = "header",j = 2:5, align = "right") %>% 
  set_caption( caption = paste("Nombre de saisies par groupe d'espèces protégées en", params$anne_fin, nom_bases)) %>% 
  bg(i=nrow(groupes_espece_pro_tableau), bg = "#DDDDDD")
  
, width = 1.4)
```

<br>

```{r , fig.width = 6.5 , fig.height = 3.5}
ggplot(espece_pro_par_annee) +
  aes(x = annee, y = nb_saisies, colour = espece_pro) +
  geom_smooth(se = FALSE) +
  geom_point()+
  scale_colour_manual(values = colors_pro) +
  labs(x = "Années",
       y = "Nombre de saisies",
       colour = "Réglementation",
       title = paste("Evolution du nombre de saisies des espèces protégées pour le SD", params$dep, nom_bases)) +
  theme_minimal() +
  theme(text = element_text(size = 9))
```

```{r , fig.width = 6.5 , fig.height = 3.5}
espece_pro <- OISON_PMC %>%
  filter(INSEE_DEP==params$dep) %>% 
  st_set_geometry(NULL) %>% 
  filter(annee==params$annee_fin) %>% 
  filter(!is.na(espece_pro)) %>% 
  group_by(espece_pro) %>% 
  summarise(nb_saisies = n()) %>% 
  arrange(nb_saisies) %>% 
  mutate(pourcentage = round((nb_saisies / sum(nb_saisies)) * 100)) %>% 
  mutate(cumulative = pourcentage / 2 + c(0, cumsum(pourcentage)[-length(pourcentage)]))

# Ordre des espèces décoissant  
espece_pro$espece_pro <- espece_pro$espece_pro %>% 
  factor(levels = rev(espece_pro$espece_pro))
```

```{r , fig.width = 6.5 , fig.height = 3.5}
ggplot(espece_pro)+
  aes(x = factor(1), y = pourcentage, fill = espece_pro) +
  geom_bar(width = 1, stat = "identity", color = "white") +
  coord_polar(theta = "y")+
  theme_void()+
  scale_fill_manual(values = colors_pro) +
  
  geom_text(aes(x = 1.8, 
                y = cumulative, 
                label=paste(espece_pro,"\n",pourcentage, "%")),
                size = 3)+
  labs(
    fill = "Réglementation",
    title = paste("Proportions des saisies des espèces protégées pour le SD", params$dep, "en", params$annee_fin,nom_bases)
    ) +
  theme(
    text = element_text(size = 9),
    plot.title = element_text(hjust = 0.2),  # Aligne le titre à gauche
    legend.margin = margin(t = 0, r = 0, b = 0, l = 50),  # Espace à gauche de la légende
    plot.margin = margin(t = 1, r = 1, b = 1, l = 1)
  )
```

```{r , fig.width = 6.5 , fig.height = 3.5}
espece_pro_dep <- OISON_PMC %>% 
  filter(INSEE_DEP==params$dep) %>% 
  filter(annee==params$annee_fin) %>% 
  filter(!is.na(espece_pro))

ggplot(espece_pro_dep) +
  aes(x = espece_pro, fill = INSEE_DEP) +
  geom_bar(position = "dodge2") +
  scale_fill_manual(values = colors_dep) +
  labs(
    x = "Réglementation",
    y = "Nombre de saisies",
    fill = "Départements",
    title = paste("Nombre de saisies des espèces protégées pour le SD", params$dep,"en", params$annee_fin, nom_bases)) +
  theme_minimal() +
  theme(text = element_text(size = 9),
        legend.margin = margin(t = 0, r = 200, b = 0, l = 0))
```


```{r}
groupes_espece_pro <- OISON_PMC %>% 
  group_by(GROUP2_INPN) %>% 
  filter(INSEE_DEP==params$dep) %>% 
  filter(!is.na(GROUP2_INPN)) %>% 
  filter(annee==params$annee_fin) %>% 
  filter(espece_pro=="Protégées") %>% 
  summarise(nb_saisies = n()) %>% 
  st_set_geometry(NULL) %>% 
  arrange(nb_saisies) %>% 
  mutate(pourcentage = round((nb_saisies / sum(nb_saisies)) * 100)) %>% 
  mutate(cumulative = pourcentage / 2 + c(0, cumsum(pourcentage)[-length(pourcentage)]))

# Ordre des espèces décoissant  
groupes_espece_pro$GROUP2_INPN <- groupes_espece_pro$GROUP2_INPN %>% 
  factor(levels = rev(groupes_espece_pro$GROUP2_INPN))
```

```{r , fig.width = 6.5 , fig.height = 3.5}
ggplot(groupes_espece_pro)+
  aes(x = factor(1), y = pourcentage, fill = GROUP2_INPN) +
  geom_bar(width = 1, stat = "identity", color = "white") +
  coord_polar(theta = "y")+
  theme_void()+
  scale_fill_manual(values = colors_esp) +
  
  geom_text(data=tail(groupes_espece_pro,2), #CHANGER LE CHIFFRE POUR AFFICHER PLUS/MOINS DE NOMS
            aes(x = 1.8, 
                y = cumulative, 
                label=paste(GROUP2_INPN,"\n",pourcentage, "%")),
                size = 3)+
  labs(
    fill = "Groupes d'espèces",
    title = paste("Saisies par groupe d'espèces protégées pour le SD", params$dep,"en",params$annee_fin,nom_bases)
    ) +
  theme(
    text = element_text(size = 9),
    plot.title = element_text(hjust = 0.2),  # Aligne le titre à gauche
    legend.margin = margin(t = 0, r = 0, b = 0, l = 50),  # Espace à gauche de la légende
    plot.margin = margin(t = 1, r = 1, b = 1, l = 1)
  )
```

\newpage

# Représentations cartographiques

```{r}
# Afficher que le département en question
departements <-  departements %>% 
  filter(INSEE_DEP==params$dep)
```

## Représentation des saisies

```{r}
observations_chaleur <- OISON_PMC %>%
  filter(INSEE_DEP==params$dep) %>% 
  filter(annee >= params$annee_debut & annee <= params$annee_fin)
```

```{r , fig.width = 6.5 , fig.height = 3.5}
ggplot(observations_chaleur) +
  geom_sf(aes(geometry = geom), lwd = 0.5, color = "red",alpha=0.3, size=1, shape = 19)+
  geom_sf(data = departements, fill = NA, color = "black", lwd = 0.5)+
  labs(title=paste("Carte de chaleur : Représentation des saisies de", params$annee_debut,"à",params$annee_fin,nom_bases))+
  theme_void() +
  theme(text = element_text(size = 9),
      plot.title = element_text(size = 9))
```

Cette carte de chaleur représente les saisies par des ronds rouge transparent. Plus une zone est couverte par des points, plus l'intensité du rouge augmente. \newpage

## Représentation des saisies par statut

```{r}
observations_statut <- OISON_PMC %>% 
  filter(INSEE_DEP==params$dep) %>% 
  filter(annee >= params$annee_debut & annee <= params$annee_fin) %>%
  filter(!is.na(statut_LR))
```

```{r , fig.width = 6.5 , fig.height = 3.5}
ggplot(observations_statut) +
  geom_sf(aes(geometry = geom, color = statut_LR), lwd = 0.5, alpha = 0.6, size = 1, shape = 19) +
  geom_sf(data = departements, fill = NA, color = "black", lwd = 0.5) +
  scale_color_manual(values = colors_statut, name = "Statut espèces") +
  labs(title = paste("Représentation des saisies par statuts de",params$annee_debut,"à",params$annee_fin,nom_bases)) +
  theme_void() +
  theme(text = element_text(size = 9),
      plot.title = element_text(size = 9))
```

```{r}
observations_statut_normale <- OISON_PMC %>% 
  filter(INSEE_DEP==params$dep) %>% 
  filter(annee >= params$annee_debut & annee <= params$annee_fin) %>% 
  filter(statut_LR=="Normales")
```

```{r , fig.width = 6.5 , fig.height = 3.5}
ggplot(observations_statut_normale) +
  geom_sf(aes(geometry = geom, color = statut_LR), lwd = 0.5, alpha = 0.6, size = 1, shape = 19) +
  geom_sf(data = departements, fill = NA, color = "black", lwd = 0.5) +
  scale_color_manual(values = colors_statut, name = "Statut espèces") +
  labs(title = paste("Représentation des saisies des espèces normales de",params$annee_debut,"à",params$annee_fin,nom_bases)) +
  theme_void() +
  theme(text = element_text(size = 9),
      plot.title = element_text(size = 9))
```

```{r}
observations_statut_menacee <- OISON_PMC %>%
  filter(INSEE_DEP==params$dep) %>% 
  filter(annee >= params$annee_debut & annee <= params$annee_fin) %>%
  filter(statut_LR=="Menacées")
```

```{r , fig.width = 6.5 , fig.height = 3.5}
ggplot(observations_statut_menacee) +
  geom_sf(aes(geometry = geom, color = statut_LR), lwd = 0.5, alpha = 0.6, size = 1, shape = 19) +
  geom_sf(data = departements, fill = NA, color = "black", lwd = 0.5) +
  scale_color_manual(values = colors_statut, name = "Statut espèces") +
  labs(title = paste("Représentation des saisies des espèces menacées de",params$annee_debut,"à",params$annee_fin,nom_bases)) +
  theme_void() +
  theme(text = element_text(size = 9),
      plot.title = element_text(size = 9))
```

```{r}
observations_statut_envahissante <- OISON_PMC %>%
  filter(INSEE_DEP==params$dep) %>% 
  filter(annee >= params$annee_debut & annee <= params$annee_fin) %>%
  filter(statut_LR=="Envahissantes")
```

```{r , fig.width = 6.5 , fig.height = 3.5}
ggplot(observations_statut_envahissante) +
  geom_sf(aes(geometry = geom, color = statut_LR), lwd = 0.5, alpha = 0.6, size = 1, shape = 19) +
  geom_sf(data = departements, fill = NA, color = "black", lwd = 0.5) +
  scale_color_manual(values = colors_statut, name = "Statut espèces") +
  labs(title = paste("Représentation des saisies des espèces envahissantes de",params$annee_debut,"",params$annee_fin,nom_bases)) +
  theme_void() +
  theme(text = element_text(size = 9),
      plot.title = element_text(size = 9))
```

## Représentation des saisies sur les espèces protégées

```{r}
observations_espece_pro <- OISON_PMC %>% 
  filter(INSEE_DEP==params$dep) %>%
  filter(annee >= params$annee_debut & annee <= params$annee_fin)
```

```{r , fig.width = 6.5 , fig.height = 3.5}
ggplot(observations_espece_pro) +
  geom_sf(aes(geometry = geom, color = espece_pro), lwd = 0.5, alpha = 0.2, size = 1.5, shape = 19) +
  geom_sf(data = departements, fill = NA, color = "black", lwd = 0.5) +
  scale_color_manual(values = colors_pro, name = "Réglementation") +
  labs(title = paste("Représentation des saisies sur les espèces protégées ou non de",params$annee_debut,"à",params$annee_fin,nom_bases)) +
  theme_void() +
  theme(text = element_text(size = 9),
      plot.title = element_text(size = 9))
```

```{r}
observations_espece_pro_seulement <- OISON_PMC %>% 
  filter(INSEE_DEP==params$dep) %>%
  filter(annee >= params$annee_debut & annee <= params$annee_fin) %>% 
  filter(espece_pro=="Protégées")
```

```{r , fig.width = 6.5 , fig.height = 3.5}
ggplot(observations_espece_pro_seulement) +
  geom_sf(aes(geometry = geom, color = espece_pro), lwd = 0.5, alpha = 0.2, size = 1.5, shape = 19) +
  geom_sf(data = departements, fill = NA, color = "black", lwd = 0.5) +
  scale_color_manual(values = colors_pro, name = "Réglementation") +
  labs(title = paste("Représentation des saisies sur les espèces protégées de",params$annee_debut,"à",params$annee_fin,nom_bases)) +
  theme_void() +
  theme(text = element_text(size = 9),
      plot.title = element_text(size = 9))
```

```{r}
observations_espece_pro_seulement <- OISON_PMC %>% 
  filter(INSEE_DEP==params$dep) %>%
  filter(annee >= params$annee_debut & annee <= params$annee_fin) %>% 
  filter(espece_pro=="Non protégées")
```

```{r , fig.width = 6.5 , fig.height = 3.5}
ggplot(observations_espece_pro_seulement) +
  geom_sf(aes(geometry = geom, color = espece_pro), lwd = 0.5, alpha = 0.2, size = 1.5, shape = 19) +
  geom_sf(data = departements, fill = NA, color = "black", lwd = 0.5) +
  scale_color_manual(values = colors_pro, name = "Réglementation") +
  labs(title = paste("Représentation des saisies sur les espèces non protégées de",params$annee_debut,"à",params$annee_fin,nom_bases)) +
  theme_void() +
  theme(text = element_text(size = 9),
      plot.title = element_text(size = 9))
```

\newpage

# Annexes

## Annexe 1 : Explications des statuts

-   Les espèces dites "normales" appartiennent à la catégorie "Autres catégories".

-   Les espèces dites "menacées" appartiennent à la catégorie "Espèces menacées de disparition de métropôle" ou "Espèces éteintes".

-   Les espèces dites "envahissantes" appartiennent à la liste des espèces envahissantes françaises.

```{r, fig.align='center', out.width="50%"}
knitr::include_graphics("../assets/Categories_LR.png")
```